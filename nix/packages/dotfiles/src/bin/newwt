#!/usr/bin/env bash
BRANCH_PREFIX="${BRANCH_PREFIX:-twhitney}"

function newwt() {
  local brname="$1"
  local skip_br="$2"

  if [[ "$(basename "$PWD")" != "main" ]]; then
    printf "ERROR: please go to the 'main' dir of your git project and try again\n"
    return 1
  fi

  # Check if .env file exists in main directory
  local has_env=0
  [[ -f .env ]] && has_env=1
  local has_vscode=0
  [[ -f .vscode ]] && has_vscode=1
  local has_zed=0
  [[ -f .zed ]] && has_zed=1

  local curbranch
  curbranch=$(git rev-parse --abbrev-ref HEAD)

  if [[ -z "$brname" ]]; then
    printf "ERROR: please specify a branch name (no prefix)\n"
    return 1
  fi

  newbr="-b ${BRANCH_PREFIX}/${brname}"
  [[ "$skip_br" == "--skip-branch" ]] && newbr=""

  # shellcheck disable=SC2086
  git worktree add ${newbr} ../${brname}
  cd "../${brname}" || return 1

  if [[ $has_env -eq 1 ]]; then
    ln -s ../main/.env .
  fi
  if [[ $has_vscode -eq 1 ]]; then
    ln -s ../main/.vscode .
  fi
  if [[ $has_zed -eq 1 ]]; then
    ln -s ../main/.zed .
  fi

  git rebase "$curbranch"

  return $?
}

newwt "$@"
