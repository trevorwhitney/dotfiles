#!/usr/bin/env zsh
set -e

if [[ $# -ne 1 ]]; then
  echo "must specify a host"
  echo "$0 host"
  exit 1
fi

host="$1"
current_dir=$(cd "$(dirname "$0")" && pwd)
host_path="$current_dir/hosts/$host.json"

if [[ ! -f "$host_path" ]]; then
  echo "host $host not found"
  exit 1
fi

if [[ ! -e "$current_dir/.last-update" ]]; then
  echo "LAST_EPOCH=18694" > "$current_dir/.last-update"
fi

set -e # Exit if any command fails

current_dir=$(cd "$(dirname $0)" && pwd)
pushd $current_dir

# only update submodules if this is still a git repo
# git stuff removed in containers
if [[ -e "$current_dir/.git" ]]; then
  git submodule update --init --recursive
fi

# Keep us from getting verify authenticity prompts from GitHub
mkdir -p $HOME/.ssh && chmod 0700 $HOME/.ssh
ssh-keyscan github.com >> ~/.ssh/known_hosts

# Install the priority units in the order they are listed
# TODO: move priority-units into host file if needed
#./install-unit < priority-units

# Then install the rest of the units
pushd $current_dir
./install-unit $(cat "$host_path" | jq -r '.units | join(" ")')
popd
